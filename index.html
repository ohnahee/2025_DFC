<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <title>Forensic Timeline</title>
  <link href="https://unpkg.com/vis-timeline@9.1.2/styles/vis-timeline-graph2d.min.css" rel="stylesheet" />
  
  <script src="https://unpkg.com/vis-timeline@9.1.2/peer/umd/vis-timeline-graph2d.min.js"></script>

  <style>
    body { font-family: Arial, sans-serif; margin: 20px; }
    #timeline { height: 600px; border: 1px solid #ccc; }
    #controls { margin-bottom: 10px; }
  </style>
</head>
<body>
  <h2>디지털 포렌식 타임라인</h2>
  <div id="controls">
    <button id="loadData">타임라인 불러오기</button>
    <select id="groupFilter"><option value="">All Groups</option></select>
  </div>
  <div id="timeline"></div>

  <script>
    // DOM이 완전히 로드된 후 스크립트를 실행
    document.addEventListener('DOMContentLoaded', function() {
      let items = new vis.DataSet([]);
      let groups = new vis.DataSet([]);
      const container = document.getElementById('timeline');
      const timeline = new vis.Timeline(container, items, groups, { stack:false, zoomKey:'ctrlKey' });

      function buildGroups(itemsArr) {
        const seen = new Set(), groupsArr = [];
        itemsArr.forEach(it => {
          const g = it.group || "Unknown";
          if (!seen.has(g)) { seen.add(g); groupsArr.push({id:g, content:g}); }
        });
        return groupsArr;
      }

      async function loadJSON() {
        try {
          const res = await fetch("./timeline.json");
          if (!res.ok) {
            console.error("timeline.json fetch error:", res.status);
            alert("타임라인 데이터를 불러오는 데 실패했습니다. (HTTP 상태: " + res.status + ")");
            return;
          }
          const data = await res.json();

          items.clear(); 
          groups.clear();

          const mapped = data.map(ev => ({
            id: ev.id,
            start: ev.start,
            end: ev.end,
            content: ev.content,
            group: ev.group,
            type: ev.type,
            title: ev.evidence ? "Evidence: " + ev.evidence : ""
          }));

          items.add(mapped);
          groups.add(buildGroups(mapped));
          timeline.setGroups(groups);
          populateGroupFilter(groups);

        } catch (error) {
          console.error("데이터 처리 중 오류 발생:", error);
          alert("타임라인 데이터를 처리하는 중 오류가 발생했습니다. timeline.json 파일 형식을 확인해주세요.");
        }
      }

      function populateGroupFilter(groupsDS) {
        const sel = document.getElementById('groupFilter');
        sel.innerHTML = '<option value="">All Groups</option>';
        groupsDS.get().forEach(g => { // .get()을 추가하여 배열로 변환
          const opt = document.createElement('option');
          opt.value = g.id; opt.textContent = g.content;
          sel.appendChild(opt);
        });
      }

      document.getElementById('loadData').addEventListener('click', loadJSON);
      document.getElementById('groupFilter').addEventListener('change', function() {
        const v = this.value;
        const allItems = items.get();
        if (!v) {
          timeline.setItems(allItems);
        } else {
          const filteredItems = allItems.filter(it => it.group === v);
          timeline.setItems(new vis.DataSet(filteredItems));
        }
      });
    });
  </script>
</body>
</html>